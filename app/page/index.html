<!DOCTYPE html>
<html>

<head>
    <!--- Use CodeMirror from https://github.com/codemirror/CodeMirror --->
    <script src='src/codemirror.min.js'></script>
    <link rel="stylesheet" type="text/css" href='src/codemirror.min.css'></link>
    <style>
        @import url('//fonts.proxy.ustclug.org/css?family=Roboto+Condensed|Ubuntu|Ubuntu+Mono');

        .center {
            display: block;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }

        table {
            margin: auto;
            font-family: 'Ubuntu', sans-serif;
        }

        textarea,
        input {
            font-family: 'Ubuntu Mono', monospace;
        }

        .right {
            float: right;
            padding: 0pt 5pt 0pt 0pt;
        }

        legend {
            font-family: 'Roboto Condensed', sans-serif;
        }

        fieldset {
            margin-left: auto;
            margin-right: auto;
            width: 590px;
        }
        
        .wrapper {
            border: 1px solid #ccc;
        }

        .hidden {
            display: none;
        }

        p {
            margin-block-end: .5em;
        }

        .CodeMirror {
            /* Set height, width, borders, and global font properties here */
            font-family: monospace;
            height: 200px;
        }
    </style>

</head>

<body>

    <fieldset>
        <legend>Compiled Result</legend>
        <img id='target' src='' class='center'>
    </fieldset>
    <br>

    <form>
        <fieldset>
            <legend>Configuration and Source code</legend>
            <table>
                <tr>
                    <td class='right'>Docuement Options:</td>
                    <td><input autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
                            id='doc-option' name='doc-option' size="35" value='varwidth,border={5pt 5pt 5pt 5pt}'></td>
                </tr>
                <tr>
                    <td class='right'>Preamble:</td>
                    <td><textarea autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
                            id="preamble" name="preamble" rows="4" cols="50">\usepackage{chemfig}</textarea></td>
                </tr>
                <tr>
                    <td class='right'>Content:</td>
                    <td><textarea autocapitalize="off" autocomplete="off" autocorrect="off" spellcheck="false"
                            id="content" name="content" rows="10" cols="50">\chemfig{A-B}</textarea></td>
                </tr>
            </table>
        </fieldset>
        <br>

        <table>
            <tr>
                <td class='right'><img id='loading' src='src/loading.gif' class="hidden"></td>
                <td>
                    <input type="button" onclick="update()" class="center" value="Compile"
                        style="font-family: 'Roboto Condensed', sans-serif;">
                </td>
            </tr>
        </table>
    </form>
    <br>
    
    <fieldset>
        <legend>fd1 & fd2</legend>
        <p>stdout</p>
        <div class="wrapper"><textarea id="stdout" name="stdout" style="display: none;" readonly></textarea></div>
        <p>stderr</p>
        <div class="wrapper"><textarea id="stderr" name="stderr" style="display: none;" readonly></textarea></div>
    </fieldset>

    <script>
        function update() {

            fliploading()

            const params = {
                'doc_option': document.getElementById('doc-option').value,
                'preamble': document.getElementById('preamble').value,
                'content': document.getElementById('content').value
            }

            postData('/', params)
                .then((resp) => {
                    if (resp.status == 200) { return resp.json() } else { console.error(resp.status); console.log(resp) }
                }).then((jresp) => {
                    document.getElementById('target').setAttribute('src', `data:${jresp['type']};base64,${jresp['attachment']}`);
                    document.getElementById('stdout').value = atou(jresp['stdout']);
                    document.getElementById('stderr').value = atou(jresp['stderr']);
                    purge_codemirror();
                    var stdout = CodeMirror.fromTextArea(document.getElementById('stdout'), {
                        lineNumbers: true
                    });
                    var stderr = CodeMirror.fromTextArea(document.getElementById('stderr'), {
                        lineNumbers: true
                    });

                }).then(end => { fliploading() },reason=>{console.error(reason)})


        }

        function fliploading() {
            var img = document.getElementById('loading');
            img.classList.toggle('hidden');
        }

        function ComposeParams(obj) {
            const params = []
            Object.keys(obj).forEach((key) => {
                let value = obj[key]
                if (!(typeof value === 'undefined')) {
                    params.push([key, utoa(value)].join('='))
                }
            })
            return params.join('&')
        }

        function postData(url, data) {
            return fetch(url, {
                body: JSON.stringify(data),
                credentials: 'same-origin',
                headers: {
                    'content-type': 'application/json'
                },
                method: 'POST'
            })
        }
        // 使用utf-8字符集进行base64编码
        function utoa(str) {
            return window.btoa(unescape(encodeURIComponent(str)));
        }
        // 使用utf-8字符集解析base64字符串 
        function atou(str) {
            return decodeURIComponent(escape(window.atob(str)));
        }

        function purge_codemirror(){
            var elements = document.getElementsByClassName('CodeMirror cm-s-default');
            while(elements.length > 0){
                elements[0].parentNode.removeChild(elements[0]);
            }
        }

        window.onload = update

    </script>
</body>

</html>